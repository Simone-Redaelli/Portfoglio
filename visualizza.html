<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Visualizza Referto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #0a192f; color: #ccd6f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        
        .toolbar { width: 100%; max-width: 210mm; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-back { background: transparent; border: 1px solid #64ffda; color: #64ffda; }
        .btn-down { background: #64ffda; color: #0a192f; }
        .btn:hover { opacity: 0.8; }

        /* FOGLIO A4 IDENTICO A PRIMA */
        .a4-page {
            background: white; width: 210mm; min-height: 297mm; padding: 20mm;
            color: #000; box-shadow: 0 0 30px rgba(0,0,0,0.8);
            font-family: 'Montserrat', sans-serif; position: relative;
        }
        .doc-header { text-align: center; margin-bottom: 30px; }
        .doc-logo { color: #cc0000; font-size: 3rem; margin-bottom: 10px; }
        .doc-title { color: #cc0000; font-weight: 700; font-size: 1.2rem; text-transform: uppercase; }
        .patient-data { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; margin-bottom: 30px; border-bottom: 2px solid #cc0000; padding-bottom: 20px; }
        .data-row span { font-weight: bold; color: #333; }
        .section-title { display: flex; align-items: center; gap: 10px; font-weight: 700; color: #003366; font-size: 1rem; margin-top: 20px; margin-bottom: 8px; }
        .section-content { font-size: 0.95rem; line-height: 1.5; color: #444; margin-left: 28px; white-space: pre-wrap; }
        .footer-sign { margin-top: 60px; text-align: right; }
        .sign-role { font-size: 0.8rem; color: #666; }
        .real-signature { font-family: 'Dancing Script', cursive; font-size: 2rem; color: #002244; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="toolbar">
        <a href="referti.html" class="btn btn-back"><i class="fa-solid fa-arrow-left"></i> Torna all'Archivio</a>
        <button onclick="scaricaPDF()" class="btn btn-down"><i class="fa-solid fa-download"></i> Scarica PDF</button>
    </div>

    <div class="a4-page" id="element-to-print">
        <div class="doc-header">
            <div class="doc-logo"><i class="fa-solid fa-star-of-life"></i></div>
            <div class="doc-title">Croce Rossa Italiana</div>
            <div style="font-size:0.8rem; color:#666;">Comitato di Esempio - Referto di Intervento</div>
        </div>

        <div class="patient-data">
            <div class="data-row"><span>Paziente:</span> <span id="v_paziente"></span></div>
            <div class="data-row"><span>Data:</span> <span id="v_data"></span></div>
            <div class="data-row"><span>Nato il:</span> <span id="v_dob"></span></div>
            <div class="data-row"><span>Telefono:</span> <span id="v_tel"></span></div>
            <div class="data-row"><span>Arrivo:</span> <span id="v_arrivo"></span></div>
            <div class="data-row"><span>Dimissione:</span> <span id="v_uscita"></span></div>
        </div>

        <div class="section-title"><i class="fa-solid fa-truck-medical"></i> Motivo dell'intervento</div>
        <div class="section-content" id="v_motivo"></div>

        <div class="section-title"><i class="fa-solid fa-clipboard-list"></i> Diagnosi e Descrizione</div>
        <div class="section-content" id="v_diagnosi"></div>

        <div class="section-title"><i class="fa-solid fa-flask"></i> Esami Diagnostici</div>
        <div class="section-content" id="v_esami"></div>

        <div class="section-title"><i class="fa-solid fa-pills"></i> Farmaci Somministrati</div>
        <div class="section-content" id="v_farmaci"></div>

        <div class="section-title"><i class="fa-solid fa-user-doctor"></i> Prescrizione Medica</div>
        <div class="section-content" id="v_prescrizione"></div>

        <div class="footer-sign">
            <div class="sign-role" id="v_ruolo"></div>
            <div class="real-signature" id="v_firma"></div>
            <div style="border-top:1px solid #ccc; width:200px; margin-left:auto; margin-top:5px;"></div>
            <div style="font-size:0.7rem; color:#999;">Firma dell'Operatore</div>
        </div>
    </div>

    <script>
        // 1. Recupera l'ID del referto che vogliamo vedere (salvato da referti.html)
        const idDaVisualizzare = localStorage.getItem('refertoDaVisualizzare');
        const archivio = JSON.parse(localStorage.getItem('archivioReferti')) || [];
        
        // 2. Trova il referto giusto nell'archivio
        const ref = archivio.find(r => r.id == idDaVisualizzare);

        if (ref) {
            // 3. RIEMPI IL FOGLIO CON I DATI
            document.getElementById('v_paziente').innerText = (ref.nome || "") + " " + (ref.cognome || "");
            document.getElementById('v_data').innerText = ref.dataCreazione || "--/--/----";
            document.getElementById('v_dob').innerText = ref.dob ? new Date(ref.dob).toLocaleDateString('it-IT') : "---";
            document.getElementById('v_tel').innerText = ref.tel || "---";
            document.getElementById('v_arrivo').innerText = ref.arrivo || "--:--";
            document.getElementById('v_uscita').innerText = ref.uscita || "--:--";
            
            document.getElementById('v_motivo').innerText = ref.motivo || "...";
            document.getElementById('v_diagnosi').innerText = ref.diagnosi || "...";
            document.getElementById('v_farmaci').innerText = ref.farmaci || "-";
            document.getElementById('v_prescrizione').innerText = ref.prescrizione || "-";

            // Gestione Esami (che sono una lista)
            let esamiTxt = "";
            if(ref.esami && ref.esami.length > 0) {
                ref.esami.forEach(e => esamiTxt += "â€¢ " + e + "\n");
            } else {
                esamiTxt = "- Nessuno selezionato";
            }
            document.getElementById('v_esami').innerText = esamiTxt;

            // Firma
            document.getElementById('v_ruolo').innerText = (ref.grado||"Grado") + " - " + (ref.spec||"");
            document.getElementById('v_firma').innerText = (ref.doc_nome||"Firma") + " " + (ref.doc_cognome||"Medico");
        
        } else {
            alert("Errore: Referto non trovato.");
            window.location.href = 'referti.html';
        }

        function scaricaPDF() {
            const el = document.getElementById('element-to-print');
            const nomeFile = `Archivio_${ref ? ref.cognome : 'Referto'}.pdf`;
            el.style.boxShadow = 'none';
            html2pdf().set({ margin:0, filename: nomeFile, image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm', format:'a4'} }).from(el).save().then(() => el.style.boxShadow = '0 0 30px rgba(0,0,0,0.8)');
        }
    </script>
</body>
</html>