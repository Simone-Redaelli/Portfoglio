<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accedi - Area Riservata</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="logger.js"></script> <style>
        /* --- 1. RESET E SFONDO --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }

        body {
            background-color: #0a192f;
            color: #ccd6f6;
            height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(100, 255, 218, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(65, 105, 225, 0.08) 0%, transparent 50%);
            overflow: hidden;
        }

        /* --- 2. CARD DI LOGIN --- */
        .login-card {
            background: rgba(17, 34, 64, 0.75);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(100, 255, 218, 0.1);
            border-radius: 24px; padding: 45px 40px;
            width: 100%; max-width: 420px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            text-align: center; position: relative; z-index: 10;
        }

        /* Logo e Titoli */
        .logo-area { margin-bottom: 35px; }
        .logo-icon-container {
            display: inline-flex; align-items: center; justify-content: center;
            width: 70px; height: 70px; background: rgba(100, 255, 218, 0.1);
            border-radius: 50%; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.2);
        }
        .logo-icon-container i { font-size: 2.2rem; color: #64ffda; }
        h2 { color: #e6f1ff; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; }
        p.subtitle { color: #8892b0; font-size: 0.95rem; }

        /* --- 3. FORM --- */
        .input-wrapper { position: relative; margin-bottom: 25px; text-align: left; }
        .input-wrapper label { display: block; color: #ccd6f6; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; padding-left: 5px; }
        .input-field-container { position: relative; }
        .input-field-container i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #8892b0; transition: 0.3s; }
        
        input {
            width: 100%; padding: 16px 16px 16px 48px;
            background: rgba(2, 12, 27, 0.5); border: 2px solid transparent;
            border-radius: 12px; color: #fff; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus { background: rgba(2, 12, 27, 0.8); border-color: #64ffda; }
        input:focus + i { color: #64ffda; }

        /* --- 4. BOTTONE --- */
        .btn-login {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, #64ffda, #4cd6b3);
            color: #0a192f; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1.05rem; cursor: pointer; transition: 0.3s;
            margin-top: 10px;
        }
        .btn-login:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(100, 255, 218, 0.4); }

        /* --- 5. LINK HOME --- */
        .back-home-link {
            margin-top: 30px; color: #8892b0; text-decoration: none;
            font-size: 0.95rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 20px; border-radius: 30px; transition: 0.3s;
        }
        .back-home-link:hover { color: #64ffda; background: rgba(100, 255, 218, 0.05); }
        /* Contenitore dello sfondo che sta dietro a tutto */
        .medical-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0b1120; /* Il tuo colore scuro di sfondo */
            z-index: -1; /* Manda lo sfondo DIETRO a tutto il resto */
            overflow: hidden;
        }

        /* Griglia stile monitor medico (opzionale, fa molto scena) */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 219, 222, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 219, 222, 0.03) 1px, transparent 1px);
            background-size: 50px 50px; /* Grandezza quadratini griglia */
            pointer-events: none;
        }

        /* Contenitore della linea */
        .heartbeat-line {
            position: absolute;
            top: 50%; /* Posizionato a metà schermo verticalmente */
            left: 0;
            width: 200%; /* Largo il doppio per permettere lo scorrimento fluido */
            height: 150px;
            transform: translateY(-50%);
            opacity: 0.4; /* Opacità bassa per non disturbare la lettura */
            display: flex;
        }

        /* Stile della linea SVG */
        .heartbeat-line svg {
            width: 50%; /* Occupa metà del contenitore largo 200% */
            height: 100%;
        }

        .heartbeat-line path {
            fill: none;
            stroke: #00dbde; /* Il tuo colore Ciano Neon */
            stroke-width: 2px;
            vector-effect: non-scaling-stroke;
            /* Effetto Neon incandescente */
            filter: drop-shadow(0 0 5px rgba(0, 219, 222, 0.8)); 
        }

        /* Animazione che muove la linea */
        .heartbeat-line {
            animation: scrollHeartbeat 10s linear infinite;
        }
        /* --- SFONDO MONITOR --- */
.monitor-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #050a14; /* Sfondo molto scuro, quasi nero */
    z-index: -1;
    overflow: hidden;
}

/* Griglia millimetrata più sottile e realistica */
.grid-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(rgba(0, 219, 222, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 219, 222, 0.05) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.6;
}

/* Vignettatura (bordi scuri) per effetto profondità */
.monitor-screen::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at center, transparent 50%, #020408 100%);
    pointer-events: none;
}

/* --- ECG SETUP --- */
.ecg-container {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 200px;
    transform: translateY(-50%);
}

.ecg-svg {
    width: 100%;
    height: 100%;
}

#ecg-path {
    fill: none;
    stroke: #00dbde; /* Il tuo colore Ciano */
    stroke-width: 3px;
    stroke-linecap: round;
    stroke-linejoin: round;
    
    /* TRUCCO PER L'ANIMAZIONE "DISEGNO" */
    /* Crea un pattern: 300px di linea, 2000px di spazio vuoto */
    stroke-dasharray: 300 2000; 
    stroke-dashoffset: 2300; /* Nasconde l'inizio */
    
    animation: liveBeat 5s linear infinite;
    
    /* Bagliore Neon */
    filter: drop-shadow(0 0 4px rgba(0, 219, 222, 0.8)) 
            drop-shadow(0 0 10px rgba(0, 219, 222, 0.4));
}

/* Animazione che fa scorrere il tratto "pieno" lungo il percorso invisibile */
@keyframes liveBeat {
    0% {
        stroke-dashoffset: 2300; /* Parte da destra (fuori) o sinistra */
    }
    100% {
        stroke-dashoffset: 0; /* Arriva alla fine */
    }
}

/* --- SECONDA LINEA FANTASMA (Opzionale) --- */
/* Aggiunge una traccia debole fissa per far vedere dove passerà la linea */
.ecg-svg::before {
    /* Questo richiederebbe duplicare l'SVG in HTML, 
       ma per semplicità lasciamo solo il raggio luminoso che è più scenico */
}

/* Raggio di scansione verticale (opzionale, stile radar) */
.scan-beam {
    position: absolute;
    top: 0;
    left: 0;
    width: 50px; /* Larghezza sfumatura */
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 219, 222, 0.1), transparent);
    animation: beamMove 4s linear infinite;
    pointer-events: none;
    display: none; /* Rimuovi questo se non ti piace l'effetto "radar" verticale */
}

@keyframes beamMove {
    0% { left: -5%; }
    100% { left: 105%; }
}

@keyframes scrollHeartbeat {
    0% {
        transform: translate(0, -50%);
    }
    100% {
        transform: translate(-50%, -50%);
    }
}

/* Se vuoi aggiungere una vignettatura scura ai bordi per focus centrale */
.medical-background::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, transparent 40%, #0b1120 100%);
    pointer-events: none;
}
    </style>
</head>
<body>
    <div class="monitor-screen">
    <div class="grid-overlay"></div>
    
    <div class="ecg-container">
        <svg viewBox="0 0 1500 200" preserveAspectRatio="none" class="ecg-svg">
            <path id="ecg-path" d="M0,100 L100,100 L120,100 L135,100 L150,50 L165,150 L180,80 L195,110 L210,100 L400,100 L420,100 L435,40 L450,160 L465,70 L480,110 L495,100 L800,100 L820,100 L835,20 L850,180 L865,60 L880,120 L895,100 L1200,100 L1220,100 L1235,50 L1250,150 L1265,80 L1280,110 L1295,100 L1500,100" 
            vector-effect="non-scaling-stroke"></path>
        </svg>
    </div>
    
    <div class="scan-beam"></div>
</div>
</div>
    <div class="login-card">
        <div class="logo-area">
            <div class="logo-icon-container">
                <i class="fa-solid fa-fingerprint"></i>
            </div>
            <h2>Bentornato!</h2>
            <p class="subtitle">Inserisci le tue credenziali per accedere.</p>
        </div>

        <div class="input-wrapper">
            <label>Email Utente</label>
            <div class="input-field-container">
                <input type="email" id="email" placeholder="nome@esempio.com">
                <i class="fa-solid fa-envelope"></i>
            </div>
        </div>

        <div class="input-wrapper">
            <label>Password</label>
            <div class="input-field-container">
                <input type="password" id="password" placeholder="••••••••">
                <i class="fa-solid fa-lock"></i>
            </div>
        </div>

        <button id="email-login-btn" class="btn-login">
            <i class="fa-solid fa-right-to-bracket" style="margin-right: 8px;"></i> Accedi
        </button>
    </div>

    <a href="index.html" class="back-home-link">
        <i class="fa-solid fa-arrow-left-long"></i> Torna alla Home del Sito
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TUA CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD1LnDnFa6Yr0y2ZA1BrnGhjxGW4TrNjm0",
            authDomain: "db--medici.firebaseapp.com",
            projectId: "db--medici",
            storageBucket: "db--medici.firebasestorage.app",
            messagingSenderId: "1036578434966",
            appId: "1:1036578434966:web:f7efe660bd2a744a99b7b7",
            measurementId: "G-SXQDDFW294"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GESTIONE LOGIN (CLICK BOTTONE) ---
        document.getElementById('email-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('email-login-btn');

            if(!email || !password) {
                Swal.fire({ icon: 'warning', title: 'Attenzione', text: 'Inserisci email e password.', background: '#112240', color: '#fff' });
                return;
            }

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Accesso in corso...';
            btn.style.opacity = "0.7";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Non serve redirect qui, ci pensa onAuthStateChanged
            } catch (error) {
                console.error("Errore:", error);
                Swal.fire({ icon: 'error', title: 'Errore', text: 'Email o password errati.', background: '#112240', color: '#fff' });
                btn.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Accedi';
                btn.style.opacity = "1";
            }
        });

        // --- FUNZIONE EXTRA: TRASFORMA EMAIL IN NOME ---
        // Se la mail è "tony.stark@cri.it" -> Restituisce "Tony Stark"
        function estraiNomeDaEmail(email) {
            try {
                const partePrimaDellaChiocciola = email.split('@')[0]; // Prende "tony.stark"
                // Divide per punto o trattino e mette le maiuscole
                return partePrimaDellaChiocciola
                    .split(/[._-]/) 
                    .map(parola => parola.charAt(0).toUpperCase() + parola.slice(1))
                    .join(' ');
            } catch (e) {
                return email; // Se fallisce, ridà la mail
            }
        }

        // --- CONTROLLO ACCESSO E SALVATAGGIO PER IL BADGE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Utente loggato:", user.email);

                // 1. PREPARA IL NOME "DI RISERVA" DALL'EMAIL
                // Così se il DB fallisce, abbiamo comunque "Tony Stark" e non la mail
                let nomePerBadge = estraiNomeDaEmail(user.email);

                try {
                    // 2. PROVA A LEGGERE IL DB
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        // Se esistono i campi specifici, usiamo quelli (hanno priorità)
                        if (userData.nome && userData.cognome) {
                            nomePerBadge = `${userData.nome} ${userData.cognome}`;
                        } else if (userData.displayName) {
                            nomePerBadge = userData.displayName;
                        }

                        // Gestione ruolo per redirect
                        if (userData.ruolo === 'admin') {
                            salvaEVai(nomePerBadge, "admin.html");
                            return;
                        }
                    } 
                    
                    // Se non esiste nel DB o non è admin nel DB, controlliamo le mail admin "hardcoded"
                    if (user.email === "ciabatta12121@gmail.com" || user.email === "redaellisimone720@gmail.com") {
                        salvaEVai(nomePerBadge, "admin.html");
                    } else {
                        salvaEVai(nomePerBadge, "portale.html");
                    }

                } catch (e) {
                    console.error("Errore recupero dati utente:", e);
                    // Fallback totale: usa il nome estratto dall'email e manda al portale
                    salvaEVai(nomePerBadge, "portale.html");
                }
            }
        });

        function salvaEVai(nome, destinazione) {
            localStorage.setItem('utenteLoggato', nome);
            if(typeof registraLog === 'function') registraLog("Login: " + nome, "Successo");
            window.location.href = destinazione;
        }
    </script>
</body>
</html>