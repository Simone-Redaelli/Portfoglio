<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Admin - Simone Redaelli</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 1. RESET BASE: Toglie i bordi bianchi fastidiosi e calcola bene le misure */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #0a192f;
            color: #ccd6f6;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh; /* Occupa tutta l'altezza dello schermo */
            width: 100vw;  /* Occupa tutta la larghezza */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Niente scroll sulla pagina intera, solo nella chat */
        }
        
        /* 2. HEADER: Occupa tutta la larghezza */
        .chat-header {
            width: 100%;
            padding: 15px 20px;
            background: #112240; /* Leggermente piÃ¹ chiaro dello sfondo */
            border-bottom: 1px solid #233554;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10; /* Sta sopra i messaggi che scorrono */
        }
        .back-btn { 
            color: #64ffda; 
            text-decoration: none; 
            font-weight: bold; 
            font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px;
        }
        .chat-header h3 { margin: 0; color: #e6f1ff; }

        /* 3. AREA MESSAGGI: Si allarga e occupa tutto lo spazio libero */
        #chat-box {
            flex: 1; /* Prendi tutto lo spazio disponibile in altezza */
            width: 100%; /* Larghezza totale */
            padding: 20px;
            overflow-y: auto; /* Abilita lo scroll qui */
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spazio tra i messaggi */
            background-image: radial-gradient(#112240 1px, transparent 1px);
            background-size: 20px 20px; /* Effetto puntinato leggero sullo sfondo */
        }

        /* 4. STILE BOLLINI (MESSAGGI) */
        .message {
            max-width: 80%; /* I messaggi non vanno oltre l'80% della larghezza */
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 1rem;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word; /* Va a capo se scrivi un poema */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .message.sent {
            align-self: flex-end; /* Allineato a DESTRA */
            background-color: #00796b; /* Verde acqua scuro */
            color: #fff;
            border-bottom-right-radius: 2px;
        }
        
        .message.received {
            align-self: flex-start; /* Allineato a SINISTRA */
            background-color: #233554; /* Grigio blu */
            color: #ccd6f6;
            border-bottom-left-radius: 2px;
        }
        
        .msg-author { 
            font-size: 0.75rem; 
            color: rgba(255,255,255,0.6); 
            margin-bottom: 4px; 
            display: block; 
            font-weight: bold;
        }

        /* 5. AREA DI SCRITTURA (FOOTER) */
        .chat-input-area {
            width: 100%;
            padding: 15px 20px;
            background: #112240;
            border-top: 1px solid #233554;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1; /* Prendi tutto lo spazio rimasto */
            padding: 15px;
            border-radius: 30px;
            border: 1px solid #233554;
            background: #0a192f;
            color: white;
            outline: none;
            font-size: 1rem;
        }
        input[type="text"]:focus { border-color: #64ffda; }
        
        button {
            background: #64ffda;
            border: none;
            width: 50px; height: 50px;
            border-radius: 50%;
            cursor: pointer;
            color: #0a192f;
            font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.1); }

    </style>
    
</head>
<body style="cursor: auto !important;">

    <div class="chat-header">
        <a href="portale.html" class="back-btn">â¬… Torna indietro</a>
        <h3>ðŸ’¬ Chat Supporto</h3>
        <div style="width: 20px;"></div> </div>

    <div id="chat-box">
        <div style="text-align: center; color: #8892b0; margin-top: 20px;">Caricamento chat...</div>
    </div>

    <form class="chat-input-area" id="msg-form">
        <input type="text" id="msg-input" placeholder="Scrivi un messaggio..." required autocomplete="off">
        <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
    </form>

    <script type="module">
        // 1. IMPORTA FIREBASE E FIRESTORE (Database)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. INCOLLA LA TUA CONFIGURAZIONE QUI SOTTO
        const firebaseConfig = {
            apiKey: "AIzaSyD1LnDnFa6Yr0y2ZA1BrnGhjxGW4TrNjm0",
            authDomain: "db--medici.firebaseapp.com",
            projectId: "db--medici",
            storageBucket: "db--medici.firebasestorage.app",
            messagingSenderId: "1036578434966",
            appId: "1:1036578434966:web:f7efe660bd2a744a99b7b7",
            measurementId: "G-SXQDDFW294"
        };

        // 3. AVVIA TUTTO
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const chatBox = document.getElementById('chat-box');
        const form = document.getElementById('msg-form');
        const input = document.getElementById('msg-input');
        let currentUser = null;

        // 4. CONTROLLA CHI Ãˆ LOGGATO
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                caricaMessaggi(); // Avvia la lettura della chat
            } else {
                window.location.href = "index.html"; // Se non loggato, via
            }
        });

        // 5. FUNZIONE PER LEGGERE I MESSAGGI IN TEMPO REALE
        function caricaMessaggi() {
            // "Ascolta" la collezione 'messaggi' ordinata per data
            const q = query(collection(db, "messaggi"), orderBy("timestamp"));
            
            onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = ""; // Pulisce la chat per ridisegnarla
                
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const div = document.createElement("div");
                    
                    // Se l'email Ã¨ la mia, il messaggio Ã¨ "SENT" (Destra), altrimenti "RECEIVED" (Sinistra)
                    const isMe = msg.email === currentUser.email;
                    div.classList.add("message", isMe ? "sent" : "received");
                    
                    div.innerHTML = `
                        <span class="msg-author">${isMe ? 'Tu' : msg.nome}</span>
                        ${msg.testo}
                    `;
                    chatBox.appendChild(div);
                });

                // Scroll automatico in basso all'ultimo messaggio
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // 6. INVIO MESSAGGIO
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Non ricaricare la pagina
            const testo = input.value;

            if (testo.trim() === "") return;

            try {
                // Scrive nel database
                await addDoc(collection(db, "messaggi"), {
                    testo: testo,
                    email: currentUser.email,
                    nome: currentUser.displayName,
                    timestamp: new Date() // Data e ora attuali
                });
                input.value = ""; // Pulisce il campo
            } catch (error) {
                console.error("Errore invio:", error);
                alert("Errore nell'invio del messaggio.");
            }
        });

    </script>
</body>
</html>