<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parco Mezzi - Gestione Flotta</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* STILE BASE (Identico a Farmacia) */
        body {
            background-color: #0a192f; color: #ccd6f6;
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0;
            display: flex; justify-content: center; cursor: auto !important;
        }

        .container { width: 90%; max-width: 1400px; margin: 40px auto; padding-bottom: 50px; }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 2px solid #233554; padding-bottom: 20px;
        }
        .header-bar h2 {
            font-size: 2rem; color: #e6f1ff; text-transform: uppercase;
            letter-spacing: 2px; border-bottom: 3px solid #64ffda;
        }
        .back-btn {
            color: #64ffda; text-decoration: none; font-size: 1.1rem;
            padding: 10px 20px; border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 5px; transition: all 0.3s;
        }
        .back-btn:hover { background: rgba(100, 255, 218, 0.1); }

        /* AREA ADMIN */
        #admin-controls {
            display: none; background: #112240; padding: 30px;
            border-radius: 10px; margin-bottom: 50px; border: 1px solid #233554;
        }
        #admin-controls h3 { color: #64ffda; margin-top: 0; border-bottom: 1px solid #233554; padding-bottom: 10px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .span-2 { grid-column: span 2; }
        
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-size: 0.9rem; color: #a8b2d1; font-weight: 600; }
        .input-group input, .input-group textarea {
            background: rgba(255, 255, 255, 0.05); border: 1px solid #233554;
            color: #fff; padding: 12px; border-radius: 6px; font-size: 1rem; outline: none;
        }
        button.add-btn {
            grid-column: span 2; background-color: #64ffda; color: #0a192f; border: none;
            padding: 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem;
        }
        button.add-btn:hover { opacity: 0.9; }

        /* RICERCA */
        .search-container { margin-bottom: 30px; position: relative; }
        .search-input {
            width: 100%; padding: 15px 15px 15px 50px;
            background-color: #112240; border: 1px solid #233554; color: #fff;
            font-size: 1.1rem; border-radius: 50px; outline: none; box-sizing: border-box;
        }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #64ffda; }

        /* GRIGLIA MEZZI */
        .med-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        
        .med-card {
            background: #112240; padding: 25px; border-radius: 8px; 
            border-left: 5px solid #ffce00; /* Giallo Ambulanza */
            position: relative; cursor: pointer; transition: transform 0.3s;
            overflow: hidden;
        }
        .med-card:hover { transform: translateY(-5px); background: #172a45; }
        
        .card-img-container {
            width: 100%; height: 180px; margin-bottom: 15px;
            border-radius: 6px; overflow: hidden; background: #0a192f;
            display: flex; align-items: center; justify-content: center;
        }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-icon-placeholder { font-size: 3rem; color: #ffce00; opacity: 0.5; }

        .med-name { font-size: 1.4rem; color: #e6f1ff; font-weight: 600; margin-bottom: 5px;}
        .med-targa { color: #8892b0; font-size: 0.9rem; margin-bottom: 10px; font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; display: inline-block;}
        .med-role { color: #ffce00; font-size: 0.9rem; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; border-top: 1px solid #233554; padding-top: 10px; margin-top: 5px;}
        
        .delete-btn {
            position: absolute; top: 10px; right: 10px; color: #fff; background: rgba(255, 95, 95, 0.8);
            border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; z-index: 10;
        }

        /* MODALE */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #112240; border: 1px solid #64ffda; padding: 0; border-radius: 12px;
            width: 90%; max-width: 700px; color: #ccd6f6; position: relative; overflow: hidden;
            max-height: 90vh; overflow-y: auto;
        }
        .close-modal { 
            position: absolute; top: 15px; right: 20px; font-size: 30px; 
            cursor: pointer; color: #fff; z-index: 20; text-shadow: 0 0 5px #000;
        }
        
        .modal-hero-img { width: 100%; height: 300px; object-fit: cover; border-bottom: 4px solid #ffce00; }
        .modal-body { padding: 30px; }
        
        .modal-title { font-size: 2.2rem; color: white; margin: 0; }
        .modal-subtitle { color: #ffce00; font-size: 1.2rem; margin-top: 5px; margin-bottom: 20px; font-family: monospace; }

        .info-section { margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 6px; }
        .info-label { color: #64ffda; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .info-text { font-size: 1rem; line-height: 1.5; color: #e6f1ff; }

        /* STILE EDIT MODE NELLA MODALE */
        .edit-modal-btn {
            background: transparent; border: 1px solid #64ffda; color: #64ffda;
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.3s;
        }
        .edit-modal-btn:hover { background: rgba(100, 255, 218, 0.1); }
        .edit-lbl { display: block; color: #8892b0; font-size: 0.85rem; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; }
        .edit-input { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #233554; color: white; border-radius: 5px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        .edit-input:focus { border-color: #64ffda; outline: none; }
        .save-edit-btn { flex: 1; background: #2ecc71; color: #0a192f; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .save-edit-btn:hover { background: #27ae60; }
        .cancel-edit-btn { background: transparent; border: 1px solid #8892b0; color: #8892b0; padding: 12px 20px; border-radius: 5px; cursor: pointer; }
        .cancel-edit-btn:hover { color: white; border-color: white; }

    </style>
</head>
<body>

    <div class="container">
        <div class="header-bar">
            <a href="portale.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
            <h2><i class="fa-solid fa-truck-medical"></i> Parco Mezzi & Flotta</h2>
        </div>

        <div id="admin-controls">
            <h3><i class="fa-solid fa-plus-circle"></i> Aggiungi Nuovo Mezzo</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>Modello Mezzo</label>
                    <input type="text" id="inNome" placeholder="Es. Fiat Ducato Ambulanza">
                </div>
                <div class="input-group">
                    <label>Targa / Codice ID</label>
                    <input type="text" id="inTarga" placeholder="Es. CRI 123AB">
                </div>
                
                <div class="input-group span-2">
                    <label>Link Foto Mezzo (URL)</label>
                    <input type="text" id="inImg" placeholder="Incolla link immagine...">
                </div>

                <div class="input-group span-2">
                    <label>Abilitazione Necessaria (Chi può usarlo?)</label>
                    <input type="text" id="inRuolo" placeholder="Es. Autista Soccorritore, Patente 5...">
                </div>
                
                <div class="input-group span-2">
                    <label>Specifiche e Prestazioni</label>
                    <textarea id="inSpecs" rows="3" placeholder="Es. Trazione integrale, Barella bariatrica, Velocità max 160km/h..."></textarea>
                </div>

                <button class="add-btn" id="btnAdd"><i class="fa-solid fa-save"></i> Aggiungi alla Flotta</button>
            </div>
        </div>

        <div class="search-container">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Cerca mezzo, targa o ruolo...">
        </div>

        <div id="mezzi-list" class="med-grid">
            <p>Caricamento parco mezzi...</p>
        </div>
    </div>

    <div id="mezzoModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modalDetails"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1LnDnFa6Yr0y2ZA1BrnGhjxGW4TrNjm0",
            authDomain: "db--medici.firebaseapp.com",
            projectId: "db--medici",
            storageBucket: "db--medici.firebasestorage.app",
            messagingSenderId: "1036578434966",
            appId: "1:1036578434966:web:f7efe660bd2a744a99b7b7",
            measurementId: "G-SXQDDFW294",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const adminControls = document.getElementById('admin-controls');
        const mezziList = document.getElementById('mezzi-list');
        const modal = document.getElementById('mezzoModal');
        const modalContent = document.getElementById('modalDetails');
        const closeModal = document.querySelector('.close-modal');

        let isAdmin = false;

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().ruolo === "admin") {
                    isAdmin = true;
                    adminControls.style.display = "block";
                }
                loadMezzi();
            } else {
                window.location.href = "login.html";
            }
        });

        // CARICAMENTO MEZZI
        async function loadMezzi() {
            mezziList.innerHTML = "";
            try {
                // Collezione 'mezzi'
                const q = query(collection(db, "mezzi"), orderBy("nome")); 
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    mezziList.innerHTML = "<p>Nessun mezzo nella flotta.</p>";
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = "med-card";
                    
                    const imageHtml = data.immagine 
                        ? `<img src="${data.immagine}" class="card-img" alt="${data.nome}" onerror="this.style.display='none'">`
                        : `<div class="card-icon-placeholder"><i class="fa-solid fa-truck-medical"></i></div>`;

                    card.onclick = (e) => {
                        if (!e.target.closest('.delete-btn')) openModal(data, docSnap.id);
                    };

                    card.innerHTML = `
                        ${isAdmin ? `<button onclick="eliminaMezzo(event, '${docSnap.id}')" class="delete-btn"><i class="fa-solid fa-trash"></i></button>` : ''}
                        <div class="card-img-container">${imageHtml}</div>
                        <div class="med-name">${data.nome}</div>
                        <div class="med-targa"><i class="fa-solid fa-barcode"></i> ${data.targa}</div>
                        <div class="med-role"><i class="fa-solid fa-user-shield"></i> Richiede: ${data.ruolo}</div>
                    `;
                    mezziList.appendChild(card);
                });
            } catch (error) { console.error(error); }
        }

        // AGGIUNGI MEZZO
        document.getElementById('btnAdd').addEventListener('click', async () => {
            const nome = document.getElementById('inNome').value.trim();
            const targa = document.getElementById('inTarga').value.trim();
            const immagine = document.getElementById('inImg').value.trim();
            const ruolo = document.getElementById('inRuolo').value.trim();
            const specifiche = document.getElementById('inSpecs').value.trim();

            if (nome && ruolo) {
                try {
                    await addDoc(collection(db, "mezzi"), { 
                        nome, targa, immagine, ruolo, specifiche
                    });
                    document.querySelectorAll('input, textarea').forEach(i => i.value = '');
                    alert("Mezzo aggiunto alla flotta!");
                    loadMezzi();
                } catch (e) { alert("Errore: " + e.message); }
            } else {
                alert("Modello e Ruolo Necessario sono obbligatori.");
            }
        });

        window.eliminaMezzo = async (event, id) => {
            event.stopPropagation();
            if (confirm("Rimuovere questo mezzo dalla flotta?")) {
                await deleteDoc(doc(db, "mezzi", id));
                loadMezzi();
            }
        };

        // RICERCA
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.med-card').forEach(card => {
                const txt = card.innerText.toLowerCase();
                card.style.display = txt.includes(term) ? "block" : "none";
            });
        });

        // --- MODALE E EDIT ---

        // 1. Apri Modale
        window.openModal = (data, id) => {
            const heroImage = data.immagine 
                ? `<img src="${data.immagine}" class="modal-hero-img">` 
                : `<div style="padding:20px; text-align:center; font-size:4rem; color:#ffce00;"><i class="fa-solid fa-truck-medical"></i></div>`;

            const editBtn = isAdmin 
                ? `<button onclick="attivaModifica('${id}')" class="edit-modal-btn"><i class="fa-solid fa-pen-to-square"></i> Modifica Mezzo</button>` 
                : '';

            modalContent.innerHTML = `
                ${heroImage}
                <div class="modal-body" id="viewMode_${id}">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <h2 class="modal-title">${data.nome}</h2>
                            <div class="modal-subtitle"><i class="fa-solid fa-barcode"></i> ${data.targa}</div>
                        </div>
                        ${editBtn}
                    </div>

                    <div class="info-section">
                        <span class="info-label"><i class="fa-solid fa-user-check"></i> Chi può utilizzarlo</span>
                        <div class="info-text" style="color:#ffce00; font-weight:bold;">${data.ruolo}</div>
                    </div>

                    <div class="info-section">
                        <span class="info-label"><i class="fa-solid fa-gears"></i> Specifiche & Prestazioni</span>
                        <div class="info-text">${data.specifiche || "Nessuna specifica inserita."}</div>
                    </div>
                    
                    <div id="hiddenData_${id}" style="display:none;" 
                        data-nome="${data.nome}" 
                        data-targa="${data.targa}" 
                        data-img="${data.immagine || ''}" 
                        data-ruolo="${data.ruolo}" 
                        data-specs="${data.specifiche || ''}">
                    </div>
                </div>
            `;
            modal.style.display = "flex";
        };

        // 2. Attiva Modifica
        window.attivaModifica = (id) => {
            const hiddenData = document.getElementById(`hiddenData_${id}`);
            const d = hiddenData.dataset;

            const viewDiv = document.getElementById(`viewMode_${id}`);
            
            viewDiv.innerHTML = `
                <h3 style="color:#64ffda; margin-top:0;">Modifica Scheda Mezzo</h3>
                
                <label class="edit-lbl">Modello</label>
                <input type="text" id="editNome" class="edit-input" value="${d.nome}">
                
                <label class="edit-lbl">Targa / ID</label>
                <input type="text" id="editTarga" class="edit-input" value="${d.targa}">

                <label class="edit-lbl">Link Foto</label>
                <input type="text" id="editImg" class="edit-input" value="${d.img}">

                <label class="edit-lbl">Abilitazione Necessaria</label>
                <input type="text" id="editRuolo" class="edit-input" value="${d.ruolo}">

                <label class="edit-lbl">Specifiche Tecniche</label>
                <textarea id="editSpecs" class="edit-input" rows="4">${d.specs}</textarea>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button onclick="salvaModifiche('${id}')" class="save-edit-btn"><i class="fa-solid fa-floppy-disk"></i> Salva Modifiche</button>
                    <button onclick="annullaModifica()" class="cancel-edit-btn">Annulla</button>
                </div>
            `;
        };

        // 3. Salva su Firebase
        window.salvaModifiche = async (id) => {
            const nome = document.getElementById('editNome').value;
            const targa = document.getElementById('editTarga').value;
            const immagine = document.getElementById('editImg').value;
            const ruolo = document.getElementById('editRuolo').value;
            const specifiche = document.getElementById('editSpecs').value;

            try {
                const docRef = doc(db, "mezzi", id);
                await updateDoc(docRef, {
                    nome, targa, immagine, ruolo, specifiche
                });
                
                alert("Scheda mezzo aggiornata!");
                modal.style.display = "none"; 
                loadMezzi();
            } catch (e) {
                alert("Errore salvataggio: " + e.message);
            }
        };

        window.annullaModifica = () => { modal.style.display = "none"; };
        closeModal.onclick = () => { modal.style.display = "none"; };
        window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };

    </script>
    <script src="logger.js"></script>
</body>
</html>